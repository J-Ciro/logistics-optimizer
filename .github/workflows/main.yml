name: CI Pipeline - Logistics Shipping Optimizer

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  backend:
    name: Backend - Build & Test
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./logistics-back
    
    strategy:
      matrix:
        node-version: [22.x]
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: ðŸ“¦ Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ./logistics-back/node_modules
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-backend-${{ hashFiles('logistics-back/package-lock.json', 'logistics-back/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-backend-
            ${{ runner.os }}-node-${{ matrix.node-version }}-
      
      - name: ðŸ“¦ Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
      
      - name: ðŸ”¨ Build TypeScript
        run: npm run build
      
      - name: ðŸ§ª Run unit tests
        #run: npm test -- --coverage --passWithNoTests
        run: npm run test:coverage || npm test -- --coverage
      
      - name: ðŸ“Š Upload coverage to Codecov (Node 20 only)
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v4
        with:
          files: ./logistics-back/coverage/lcov.info
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
      
      - name: ðŸ“ˆ Check coverage threshold (70%+)
        if: matrix.node-version == '20.x'
        run: |
          COVERAGE=$(npm test -- --coverage --silent | grep "All files" | awk '{print $10}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "âŒ Coverage is below 70%: ${COVERAGE}%"
            exit 1
          else
            echo "âœ… Coverage meets threshold: ${COVERAGE}%"
          fi

  frontend:
    name: Frontend - Build & Test
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./logistics-front
    
    strategy:
      matrix:
        node-version: [22.x]
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: ðŸ“¦ Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ./logistics-front/node_modules
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-frontend-${{ hashFiles('logistics-front/package-lock.json', 'logistics-front/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-frontend-
            ${{ runner.os }}-node-${{ matrix.node-version }}-
      
      - name: ðŸ“¦ Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
      
      - name: ðŸ” Run ESLint
        run: npm run lint
      
      - name: ðŸ”¨ Build Vite production bundle
        run: npm run build
      
      - name: ðŸ§ª Run unit tests (Vitest)
        run: npm test -- --coverage --passWithNoTests
      
      
      - name: ðŸ“Š Upload coverage to Codecov (Node 20 only)
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v4
        with:
          files: ./logistics-front/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

  ci-success:
    name: âœ… CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: success()
    
    steps:
      - name: ðŸŽ‰ All checks passed
        run: |
          echo "âœ… Backend: Build & Tests passed"
          echo "âœ… Frontend: Build & Tests passed"
          echo "ðŸš€ Ready for deployment"

  ci-failure:
    name: âŒ CI Pipeline Failed
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: failure()
    
    steps:
      - name: ðŸ’¥ Pipeline failed
        run: |
          echo "âŒ One or more jobs failed"
          echo "ðŸ“ Check logs above for details"
          exit 1
